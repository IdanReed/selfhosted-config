{"ignition":{"version":"3.3.0"},"passwd":{"users":[{"groups":["sudo","docker"],"name":"idan","sshAuthorizedKeys":["${SSH_AUTHORIZED_KEY}"],"shell":"/bin/bash"}]},"storage":{"directories":[{"path":"/srv/stacks","mode":493},{"path":"/mnt/fast/docker","mode":457},{"path":"/var/lib/docker","mode":457},{"path":"/opt/bin","mode":493}],"disks":[{"device":"/dev/disk/by-id/scsi-0QEMU_QEMU_HARDDISK_flatcar-state","partitions":[{"label":"state","number":1,"sizeMiB":0}],"wipeTable":true},{"device":"/dev/disk/by-id/scsi-0QEMU_QEMU_HARDDISK_flatcar-fast","partitions":[{"label":"fast","number":1,"sizeMiB":0}],"wipeTable":true},{"device":"/dev/disk/by-id/scsi-0QEMU_QEMU_HARDDISK_flatcar-slow","partitions":[{"label":"slow","number":1,"sizeMiB":0}],"wipeTable":true}],"filesystems":[{"device":"/dev/disk/by-partlabel/state","format":"ext4","path":"/srv"},{"device":"/dev/disk/by-partlabel/fast","format":"ext4","path":"/mnt/fast"},{"device":"/dev/disk/by-partlabel/slow","format":"ext4","path":"/mnt/slow"}]},"systemd":{"units":[{"contents":"# Generated by Butane\n[Unit]\nRequires=systemd-fsck@dev-disk-by\\x2dpartlabel-state.service\nAfter=systemd-fsck@dev-disk-by\\x2dpartlabel-state.service\n\n[Mount]\nWhere=/srv\nWhat=/dev/disk/by-partlabel/state\nType=ext4\n\n[Install]\nRequiredBy=local-fs.target","enabled":true,"name":"srv.mount"},{"contents":"# Generated by Butane\n[Unit]\nRequires=systemd-fsck@dev-disk-by\\x2dpartlabel-fast.service\nAfter=systemd-fsck@dev-disk-by\\x2dpartlabel-fast.service\n\n[Mount]\nWhere=/mnt/fast\nWhat=/dev/disk/by-partlabel/fast\nType=ext4\n\n[Install]\nRequiredBy=local-fs.target","enabled":true,"name":"mnt-fast.mount"},{"contents":"# Generated by Butane\n[Unit]\nRequires=systemd-fsck@dev-disk-by\\x2dpartlabel-slow.service\nAfter=systemd-fsck@dev-disk-by\\x2dpartlabel-slow.service\n\n[Mount]\nWhere=/mnt/slow\nWhat=/dev/disk/by-partlabel/slow\nType=ext4\n\n[Install]\nRequiredBy=local-fs.target","enabled":true,"name":"mnt-slow.mount"},{"contents":"[Unit]\nDescription=Set timezone to America/Chicago\nBefore=multi-user.target\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStart=/usr/bin/ln -snf /usr/share/zoneinfo/America/Chicago /etc/localtime\n\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"set-timezone.service"},{"contents":"[Unit]\nDescription=Bind mount Docker data to fast storage\nRequires=mnt-fast.mount\nAfter=mnt-fast.mount\n\n[Mount]\nWhat=/mnt/fast/docker\nWhere=/var/lib/docker\nType=none\nOptions=bind\n\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"var-lib-docker.mount"},{"dropins":[{"contents":"[Unit]\nRequires=var-lib-docker.mount\nAfter=var-lib-docker.mount\n","name":"10-wait-docker-root.conf"}],"enabled":true,"name":"docker.service"},{"contents":"[Unit]\nDescription=Install Docker Compose plugin\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nEnvironment=DC_VERSION=2.32.4\nExecCondition=/bin/bash -c '! test -x /opt/docker/cli-plugins/docker-compose'\nExecStart=/bin/bash -euxo pipefail -c '\\\n  install -d /opt/docker/cli-plugins /root/.docker/cli-plugins /home/idan/.docker/cli-plugins \u0026\u0026 \\\n  curl -fsSL \"https://github.com/docker/compose/releases/download/v$${DC_VERSION}/docker-compose-linux-x86_64\" \\\n    -o /opt/docker/cli-plugins/docker-compose \u0026\u0026 \\\n  chmod +x /opt/docker/cli-plugins/docker-compose \u0026\u0026 \\\n  ln -sf /opt/docker/cli-plugins/docker-compose /root/.docker/cli-plugins/docker-compose \u0026\u0026 \\\n  ln -sf /opt/docker/cli-plugins/docker-compose /home/idan/.docker/cli-plugins/docker-compose \u0026\u0026 \\\n  chown -R idan:idan /home/idan/.docker \\\n'\n\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"install-docker-compose.service"},{"contents":"[Unit]\nDescription=Install Tailscale\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nEnvironment=TS_VERSION=1.78.3\nExecCondition=/bin/bash -c '! test -x /opt/bin/tailscale'\nExecStart=/bin/bash -euxo pipefail -c '\\\n  curl -fsSL \"https://pkgs.tailscale.com/stable/tailscale_$${TS_VERSION}_amd64.tgz\" -o /tmp/tailscale.tgz \u0026\u0026 \\\n  tar -xzf /tmp/tailscale.tgz -C /tmp \u0026\u0026 \\\n  cp /tmp/tailscale_$${TS_VERSION}_amd64/tailscale /opt/bin/ \u0026\u0026 \\\n  cp /tmp/tailscale_$${TS_VERSION}_amd64/tailscaled /opt/bin/ \u0026\u0026 \\\n  chmod +x /opt/bin/tailscale /opt/bin/tailscaled \u0026\u0026 \\\n  rm -rf /tmp/tailscale* \\\n'\n\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"install-tailscale.service"},{"contents":"[Unit]\nDescription=Tailscale Daemon\nWants=network-online.target\nAfter=network-online.target install-tailscale.service\nRequires=install-tailscale.service\n\n[Service]\nExecStart=/opt/bin/tailscaled --state=/var/lib/tailscale/tailscaled.state --socket=/run/tailscale/tailscaled.sock\nRestart=on-failure\nRuntimeDirectory=tailscale\nStateDirectory=tailscale\n\n[Install]\nWantedBy=multi-user.target\n","enabled":true,"name":"tailscaled.service"},{"contents":"[Unit]\nDescription=Tailscale Login\nAfter=tailscaled.service\nRequires=tailscaled.service\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStart=/opt/bin/tailscale up --authkey=${TAILSCALE_AUTH_KEY} --accept-routes\n\n[Install]\nWantedBy=multi-user.target","enabled":true,"name":"tailscale-up.service"}]}}
